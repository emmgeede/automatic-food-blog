---
interface Ingredient {
  quantity?: string;
  unit?: string;
  ingredient: string;
  group?: string | null;
}

interface Step {
  number: number;
  title?: string;
  shortText?: string;
  text: string;
}

interface Timing {
  prepTime?: string;
  cookTime?: string;
  totalTime?: string;
}

interface Nutrition {
  servings?: number;
  calories?: string;
}

interface Props {
  title: string;
  description?: string;
  ingredients: Ingredient[];
  steps: Step[];
  timing?: Timing;
  nutrition?: Nutrition;
  recipeSlug: string;
}

const { title, description, ingredients, steps, timing, nutrition, recipeSlug } = Astro.props;

// Helper function to format ISO 8601 duration
function formatDuration(duration?: string): string {
  if (!duration) return '';

  const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
  if (!match) return '';

  const hours = match[1] ? parseInt(match[1]) : 0;
  const minutes = match[2] ? parseInt(match[2]) : 0;

  if (hours && minutes) return `${hours} Std ${minutes} Min`;
  if (hours) return `${hours} Std`;
  if (minutes) return `${minutes} Min`;
  return '';
}
---

<div class="recipe-card bg-white rounded-xl shadow-lg border-2 border-accent/20 p-8 mb-8 print:shadow-none print:border print:border-gray-300" id="recipe-card">
  <!-- Header -->
  <div class="recipe-card-header mb-6 pb-6 border-b-2 border-accent/10 print:border-gray-300">
    <h2 class="text-3xl font-bold text-gray-900 mb-3 print:text-2xl">{title}</h2>
    {description && (
      <p class="text-gray-700 leading-relaxed print:text-sm">{description}</p>
    )}
  </div>

  <!-- Meta Information -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 print:grid-cols-4 print:gap-2">
    {timing?.prepTime && (
      <div class="flex flex-col items-center p-4 bg-accent/5 rounded-lg print:bg-transparent print:border print:border-gray-300">
        <svg class="w-6 h-6 text-accent mb-2 print:w-5 print:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="text-xs text-gray-600 mb-1 print:text-[10px]">Vorbereitung</span>
        <span class="text-sm font-semibold text-gray-900 print:text-xs">{formatDuration(timing.prepTime)}</span>
      </div>
    )}

    {timing?.cookTime && (
      <div class="flex flex-col items-center p-4 bg-accent/5 rounded-lg print:bg-transparent print:border print:border-gray-300">
        <svg class="w-6 h-6 text-accent mb-2 print:w-5 print:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
        </svg>
        <span class="text-xs text-gray-600 mb-1 print:text-[10px]">Kochzeit</span>
        <span class="text-sm font-semibold text-gray-900 print:text-xs">{formatDuration(timing.cookTime)}</span>
      </div>
    )}

    {timing?.totalTime && (
      <div class="flex flex-col items-center p-4 bg-accent/5 rounded-lg print:bg-transparent print:border print:border-gray-300">
        <svg class="w-6 h-6 text-accent mb-2 print:w-5 print:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="text-xs text-gray-600 mb-1 print:text-[10px]">Gesamt</span>
        <span class="text-sm font-semibold text-gray-900 print:text-xs">{formatDuration(timing.totalTime)}</span>
      </div>
    )}

    {nutrition?.servings && (
      <div class="flex flex-col items-center p-4 bg-accent/5 rounded-lg print:bg-transparent print:border print:border-gray-300">
        <svg class="w-6 h-6 text-accent mb-2 print:w-5 print:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span class="text-xs text-gray-600 mb-1 print:text-[10px]">Portionen</span>
        <span class="text-sm font-semibold text-gray-900 print:text-xs">{nutrition.servings}</span>
      </div>
    )}
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-3 mb-6 print:hidden">
    <button
      id="print-recipe-btn"
      class="flex items-center gap-2 px-4 py-2.5 bg-accent hover:bg-accent-dark text-white font-medium rounded-lg transition-colors shadow-md hover:shadow-lg"
      aria-label="Rezept drucken"
    >
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
      </svg>
      <span>Drucken</span>
    </button>

    <button
      id="keep-awake-btn"
      class="flex items-center gap-2 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-900 font-medium rounded-lg transition-colors border border-gray-300"
      aria-label="Bildschirm aktiv halten"
      data-active="false"
    >
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
      <span id="keep-awake-text">Bildschirm aktiv</span>
    </button>
  </div>

  <!-- Ingredients -->
  <div class="mb-6">
    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2 print:text-lg">
      <svg class="w-5 h-5 text-accent print:w-4 print:h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
      Zutaten
    </h3>
    <ul class="space-y-2 print:space-y-1">
      {ingredients.map((ingredient) => (
        <li class="flex items-start gap-2 print:text-sm">
          <span class="text-accent mt-1.5 print:mt-1">•</span>
          <span class="text-gray-900">
            {ingredient.quantity && <span class="font-medium">{ingredient.quantity} </span>}
            {ingredient.unit && <span>{ingredient.unit} </span>}
            <span>{ingredient.ingredient}</span>
          </span>
        </li>
      ))}
    </ul>
  </div>

  <!-- Instructions -->
  <div class="mb-6">
    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2 print:text-lg">
      <svg class="w-5 h-5 text-accent print:w-4 print:h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      Zubereitung
    </h3>
    <ol class="space-y-4 print:space-y-2">
      {steps.map((step) => (
        <li class="flex gap-3 print:gap-2">
          <span class="flex-shrink-0 w-7 h-7 flex items-center justify-center bg-accent text-white rounded-full font-bold text-sm print:w-6 print:h-6 print:text-xs">
            {step.number}
          </span>
          <div class="flex-1 pt-0.5">
            {step.title && <h4 class="font-semibold text-gray-900 mb-1 print:text-sm">{step.title}</h4>}
            <p class="text-gray-700 leading-relaxed print:text-sm">
              {step.shortText || step.text}
            </p>
          </div>
        </li>
      ))}
    </ol>
  </div>

  <!-- Footer (Only visible on screen) -->
  <div class="mt-6 pt-6 border-t-2 border-accent/10 text-center text-sm text-gray-600 print:hidden">
    <p>Rezept von <a href="/" class="text-accent hover:underline font-medium">Die Mama kocht</a></p>
  </div>
</div>

<script>
  import { trackButtonClick } from "../../utils/matomoTracking";

  // Print functionality
  const printBtn = document.getElementById('print-recipe-btn');
  if (printBtn) {
    printBtn.addEventListener('click', () => {
      trackButtonClick('Rezept drucken', 'Recipe Card');
      window.print();
    });
  }

  // Screen Wake Lock functionality
  let wakeLock: WakeLockSentinel | null = null;
  const keepAwakeBtn = document.getElementById('keep-awake-btn');
  const keepAwakeText = document.getElementById('keep-awake-text');

  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');

        if (keepAwakeBtn && keepAwakeText) {
          keepAwakeBtn.setAttribute('data-active', 'true');
          keepAwakeBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-900', 'border-gray-300');
          keepAwakeBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'border-green-600');
          keepAwakeText.textContent = 'Bildschirm aktiv ✓';
        }

        trackButtonClick('Bildschirm aktiv halten', 'Recipe Card - Aktiviert');

        // Re-acquire wake lock when page becomes visible again
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock released');
        });
      } else {
        alert('Screen Wake Lock wird von deinem Browser nicht unterstützt.');
      }
    } catch (err) {
      console.error('Wake Lock error:', err);
      alert('Bildschirm-Wachhalten konnte nicht aktiviert werden.');
    }
  }

  async function releaseWakeLock() {
    if (wakeLock) {
      await wakeLock.release();
      wakeLock = null;

      if (keepAwakeBtn && keepAwakeText) {
        keepAwakeBtn.setAttribute('data-active', 'false');
        keepAwakeBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white', 'border-green-600');
        keepAwakeBtn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-900', 'border-gray-300');
        keepAwakeText.textContent = 'Bildschirm aktiv';
      }

      trackButtonClick('Bildschirm aktiv halten', 'Recipe Card - Deaktiviert');
    }
  }

  if (keepAwakeBtn) {
    keepAwakeBtn.addEventListener('click', async () => {
      const isActive = keepAwakeBtn.getAttribute('data-active') === 'true';

      if (isActive) {
        await releaseWakeLock();
      } else {
        await requestWakeLock();
      }
    });
  }

  // Re-acquire wake lock when page becomes visible
  document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
      await requestWakeLock();
    }
  });

  // Release wake lock when page is unloaded
  window.addEventListener('beforeunload', () => {
    if (wakeLock) {
      wakeLock.release();
    }
  });
</script>

<style>
  /* Print styles */
  @media print {
    /* Only show recipe card when printing */
    @page {
      margin: 1.5cm;
      size: A4;
    }

    /* Hide all page elements */
    body * {
      visibility: hidden;
    }

    /* Show only recipe card and its children */
    .recipe-card,
    .recipe-card * {
      visibility: visible;
    }

    /* Position recipe card at top of page */
    .recipe-card {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      break-inside: avoid;
      page-break-inside: avoid;
      box-shadow: none !important;
    }
  }
</style>
