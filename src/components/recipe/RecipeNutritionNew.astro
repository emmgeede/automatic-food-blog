---
interface Nutrition {
  servings?: number | string;
  servingSize?: string;
  calories?: string;
  carbohydrates?: string;
  protein?: string;
  fat?: string;
  fiber?: string;
  sugar?: string | null;
  sodium?: string | null;
}

interface Props {
  nutrition?: Nutrition;
}

const { nutrition } = Astro.props;

// Extract number and unit from value string (e.g., "12g" -> { number: 12, unit: "g" })
const parseNutritionValue = (value: string | undefined): { number: string; unit: string } => {
  if (!value) return { number: '0', unit: '' };
  const match = value.match(/^([\d.]+)\s*(.*)$/);
  if (match) {
    return { number: match[1], unit: match[2] || '' };
  }
  return { number: value, unit: '' };
};

// Calculate percentages based on daily values (example values)
const getDailyPercentage = (nutrient: string, value: string | undefined): number => {
  if (!value) return 0;
  const numValue = parseFloat(value);

  const dailyValues: Record<string, number> = {
    calories: 2000,
    fat: 78,
    carbohydrates: 275,
    protein: 50,
    fiber: 28,
    sodium: 2300,
    sugar: 50
  };

  const dv = dailyValues[nutrient];
  if (!dv) return 0;

  return Math.round((numValue / dv) * 100);
};

// SVG Icons for nutrition items
const getIconSvg = (key: string) => {
  switch (key) {
    case 'calories':
      // Fire/Flame icon
      return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />';
    case 'fat':
      // Fat/lipid icon - hexagons (molecular structure) with droplet
      return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 4l-2 1.2v2.6L8 9l2-1.2V5.2L8 4M16 4l-2 1.2v2.6l2 1.2 2-1.2V5.2L16 4M4 12l-2 1.2v2.6l2 1.2 2-1.2v-2.6L4 12" fill="none" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 13c0 3-2.5 5-4 7-.5.7-1 1-1 1s-.5-.3-1-1c-1.5-2-4-4-4-7s2-4 4-4c1 0 2 .5 2.5 1.5.5-1 1.5-1.5 2.5-1.5 2 0 4 1 4 4z" fill="none" />';
    case 'carbohydrates':
      // Wheat spikelet icon - detailed grain structure
      return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2v20M10 4c-1 0-2 .5-2 1.5s1 1.5 2 1.5M14 4c1 0 2 .5 2 1.5S15 7 14 7M9.5 7.5c-1.2 0-2.5.5-2.5 2s1.3 2 2.5 2M14.5 7.5c1.2 0 2.5.5 2.5 2s-1.3 2-2.5 2M9 12c-1.5 0-3 .5-3 2.5s1.5 2.5 3 2.5M15 12c1.5 0 3 .5 3 2.5s-1.5 2.5-3 2.5M10 17.5c-1 0-2 .5-2 1.5s1 1.5 2 1.5M14 17.5c1 0 2 .5 2 1.5s-1 1.5-2 1.5" />';
    case 'protein':
      // Fried egg icon
      return '<ellipse cx="12" cy="13" rx="7" ry="6" stroke-width="1.5" fill="none" /><circle cx="12" cy="12" r="3" stroke-width="1.5" fill="none" />';
    case 'fiber':
      // Sparkle/Star icon for fiber
      return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />';
    case 'sodium':
      // Cube/Salt crystal icon
      return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />';
    default:
      return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />';
  }
};

const nutritionItems = [
  { label: 'Kalorien', value: nutrition?.calories, key: 'calories' },
  { label: 'Fett', value: nutrition?.fat, key: 'fat' },
  { label: 'Kohlenhydrate', value: nutrition?.carbohydrates, key: 'carbohydrates' },
  { label: 'Eiweiß', value: nutrition?.protein, key: 'protein' },
  { label: 'Ballaststoffe', value: nutrition?.fiber, key: 'fiber' },
  { label: 'Natrium', value: nutrition?.sodium, key: 'sodium' },
].filter(item => item.value);
---

{nutrition && (
  <section class="bg-white rounded-lg p-8 mb-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Nährwertangaben</h2>

    {nutrition.servingSize && (
      <p class="text-sm text-gray-600 mb-6">
        Pro Portion: <span class="font-semibold text-gray-900">{nutrition.servingSize}</span>
      </p>
    )}

    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      {nutritionItems.map((item) => {
        const percentage = getDailyPercentage(item.key, item.value);
        const parsed = parseNutritionValue(item.value);
        return (
          <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
            <div class="flex justify-center mb-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-primary-light"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
                set:html={getIconSvg(item.key)}
              />
            </div>
            <div class="text-3xl font-bold text-primary mb-1">
              {parsed.number}
              {parsed.unit && <span class="text-sm font-normal text-gray-500">{parsed.unit}</span>}
            </div>
            <div class="text-xs font-medium text-gray-700 mb-1">{item.label}</div>
            {percentage > 0 && (
              <div class="text-xs text-gray-500">{percentage}%</div>
            )}
          </div>
        );
      })}
    </div>

    <p class="text-xs text-gray-500 mt-4 text-center">
      * Prozentangaben basieren auf einer Ernährung mit 2000 Kalorien pro Tag
    </p>
  </section>
)}
