---
import { Image } from "astro:assets";
import profileImage from "../../../public/images/about/ingrid-profile.jpg";

interface Props {
  recipeSlug: string;
  recipeTitle: string;
}

const { recipeSlug, recipeTitle } = Astro.props;

// Author info
const author = {
  name: "Ingrid Hartmann",
  role: "Rezeptautorin",
  bio: "Leidenschaftliche K√∂chin und Oma von 4 Enkelkindern",
};

// Turnstile Site Key from environment
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
const remark42Url = import.meta.env.PUBLIC_REMARK42_URL || 'https://comments.die-mama-kocht.de';

// Check if required environment variables are set
const isConfigured = !!turnstileSiteKey;
---

<section class="bg-white rounded-lg p-8 mb-8" id="comments-section">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">Kommentare</h2>

  <!-- Author Profile Info -->
  <div class="flex items-center gap-4 p-4 mb-6 bg-accent/5 rounded-lg border-l-4 border-accent">
    <a href="/ueber-mich" class="flex-shrink-0 group" title="Mehr √ºber Ingrid erfahren">
      <div class="w-16 h-16 rounded-full overflow-hidden ring-2 ring-accent/20 group-hover:ring-accent transition-all">
        <Image
          src={profileImage}
          alt={author.name}
          class="w-full h-full object-cover"
          widths={[64, 128]}
          sizes="64px"
          loading="lazy"
          quality={90}
        />
      </div>
    </a>
    <div class="flex-1">
      <a href="/ueber-mich" class="group">
        <h3 class="font-semibold text-gray-900 group-hover:text-accent transition-colors">
          {author.name}
        </h3>
      </a>
      <p class="text-sm text-gray-600 mt-1">
        Ich freue mich auf deine Fragen und beantworte sie gerne pers√∂nlich! üí¨
      </p>
    </div>
  </div>

  {!isConfigured ? (
    <!-- Error message if environment variables are missing -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">
            Kommentarfunktion ist derzeit nicht verf√ºgbar. Bitte versuche es sp√§ter erneut.
          </p>
        </div>
      </div>
    </div>
  ) : (
    <>
      <!-- Turnstile Verification -->
      <div id="turnstile-wrapper" class="mb-6">
        <p class="text-sm text-gray-600 mb-4">
          Bitte verifiziere dich, um Kommentare zu sehen und zu schreiben.
        </p>
        <div
          id="turnstile-container"
          class="cf-turnstile"
          data-sitekey={turnstileSiteKey}
          data-callback="onTurnstileSuccess"
          data-error-callback="onTurnstileError"
          data-expired-callback="onTurnstileExpired"
          data-theme="light"
          data-size="normal"
        ></div>
        <div id="turnstile-status" class="mt-4"></div>
      </div>
    </>
  )}

  <!-- Remark42 Container (initially hidden) -->
  <div id="remark42" class="hidden"></div>
</section>

<!-- Cloudflare Turnstile Script -->
<script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<!-- Remark42 Integration Script -->
<script is:inline define:vars={{ remark42Url, recipeTitle }}>
  let turnstileVerified = false;
  let turnstileWidget = null;

  // Turnstile Success Callback
  window.onTurnstileSuccess = async function(token) {
    console.log('Turnstile challenge completed, validating token...');

    const statusDiv = document.getElementById('turnstile-status');
    if (statusDiv) {
      statusDiv.innerHTML = '<p class="text-sm text-blue-600">‚è≥ Verifizierung l√§uft...</p>';
    }

    try {
      // Validate with backend
      const response = await fetch('/.netlify/functions/validate-turnstile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token }),
      });

      const result = await response.json();

      if (result.success) {
        turnstileVerified = true;

        if (statusDiv) {
          statusDiv.innerHTML = '<p class="text-sm text-green-600">‚úì Verifizierung erfolgreich! Kommentare werden geladen...</p>';
        }

        // Wait a moment for better UX
        setTimeout(() => {
          // Hide Turnstile wrapper
          const wrapper = document.getElementById('turnstile-wrapper');
          if (wrapper) {
            wrapper.style.display = 'none';
          }

          // Show Remark42
          const remark42Container = document.getElementById('remark42');
          if (remark42Container) {
            remark42Container.classList.remove('hidden');
          }

          // Initialize Remark42
          initRemark42();

          // Handle comment fragment after Remark42 is initialized
          if (window.location.hash && window.location.hash.includes('remark42__comment')) {
            console.log('Detected comment fragment after Turnstile:', window.location.hash);
            setTimeout(() => {
              const commentsSection = document.getElementById('remark42');
              if (commentsSection) {
                commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log('Scrolled to comments section');
              }
            }, 2000);
          }
        }, 500);
      } else {
        if (statusDiv) {
          statusDiv.innerHTML = '<p class="text-sm text-red-600">‚ùå Verifizierung fehlgeschlagen. Bitte versuche es erneut.</p>';
        }
        // Reset Turnstile widget
        if (window.turnstile) {
          window.turnstile.reset();
        }
      }
    } catch (error) {
      console.error('Validation error:', error);
      if (statusDiv) {
        statusDiv.innerHTML = '<p class="text-sm text-red-600">‚ùå Fehler bei der Verifizierung. Bitte lade die Seite neu.</p>';
      }
    }
  };

  // Turnstile Error Callback
  window.onTurnstileError = function(error) {
    console.error('Turnstile error:', error);
    const statusDiv = document.getElementById('turnstile-status');
    if (statusDiv) {
      statusDiv.innerHTML = '<p class="text-sm text-red-600">‚ùå Verifizierung fehlgeschlagen. Bitte lade die Seite neu.</p>';
    }
  };

  // Turnstile Expired Callback
  window.onTurnstileExpired = function() {
    console.warn('Turnstile token expired');
    const statusDiv = document.getElementById('turnstile-status');
    if (statusDiv) {
      statusDiv.innerHTML = '<p class="text-sm text-orange-600">‚ö†Ô∏è Verifizierung abgelaufen. Bitte l√∂se das Captcha erneut.</p>';
    }
    turnstileVerified = false;
  };

  // Initialize Remark42
  function initRemark42() {
    console.log('Initializing Remark42...');

    // Set global config BEFORE loading scripts
    window.remark_config = {
      host: remark42Url,
      site_id: 'food-blog',
      components: ['embed', 'counter'],
      url: 'https://die-mama-kocht.de' + window.location.pathname,
      locale: 'de',
      theme: 'light',
      page_title: recipeTitle,
      show_email_subscription: true,
      simple_view: false,
      no_footer: false,
    };

    // Load Remark42 scripts
    (function(c) {
      for(var i = 0; i < c.length; i++){
        var d = document, s = d.createElement('script');
        s.src = window.remark_config.host + '/web/' + c[i] + '.js';
        s.defer = true;
        (d.head || d.body).appendChild(s);
      }
    })(window.remark_config.components || ['embed']);

    // Inject custom styles into Remark42 iframe after it loads
    setTimeout(function() {
      try {
        const iframe = document.querySelector('iframe[id^="remark42"]');
        if (iframe && iframe.contentDocument) {
          const style = iframe.contentDocument.createElement('link');
          style.rel = 'stylesheet';
          style.href = '/remark42-custom.css';
          iframe.contentDocument.head.appendChild(style);
        }
      } catch(e) {
        console.warn('Could not inject custom styles into Remark42 iframe (CORS):', e);
      }
    }, 2000);

    // Handle comment fragment links (e.g., #remark42__comment-xxx)
    // Remark42 supports fragments natively, but we need to scroll to the comments section first
    if (window.location.hash && window.location.hash.includes('remark42__comment')) {
      console.log('Detected comment fragment:', window.location.hash);

      // Immediately scroll to comments section
      setTimeout(function() {
        const commentsSection = document.getElementById('remark42');
        if (commentsSection) {
          commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('Scrolled to comments section, waiting for Remark42 to load...');

          // Remark42 will automatically handle the fragment when the iframe loads
          // We just need to ensure the comments section is visible
        }
      }, 1000);
    }
  }

  // Check if Turnstile is already loaded, otherwise wait
  if (typeof turnstile !== 'undefined') {
    console.log('Turnstile already loaded');
  } else {
    console.log('Waiting for Turnstile to load...');
  }

  // Quick fix: Replace "admin" with "Ingrid Hartmann" in comments
  function replaceAdminWithIngrid() {
    console.log('Checking for admin comments to replace...');

    // Wait for Remark42 iframe to load
    const iframe = document.querySelector('iframe[id^="remark42"]');
    if (!iframe || !iframe.contentDocument) {
      console.log('Remark42 iframe not ready yet, will retry...');
      return;
    }

    try {
      const iframeDoc = iframe.contentDocument;

      // Find all author names with "admin"
      const authorElements = iframeDoc.querySelectorAll('.user-name, .comment-author, [class*="author"]');

      let replaced = 0;
      authorElements.forEach(el => {
        if (el.textContent && el.textContent.trim().toLowerCase() === 'admin') {
          console.log('Found admin comment, replacing with Ingrid Hartmann');
          el.textContent = 'Ingrid Hartmann';
          replaced++;

          // Try to replace avatar if present
          const avatarContainer = el.closest('.comment-header, .comment-info, [class*="header"]');
          if (avatarContainer) {
            const avatar = avatarContainer.querySelector('img[class*="avatar"], .avatar img, [class*="picture"]');
            if (avatar) {
              avatar.src = '/images/about/ingrid-profile.jpg';
              avatar.alt = 'Ingrid Hartmann';
              console.log('Replaced admin avatar');
            }
          }
        }
      });

      console.log(`Replaced ${replaced} admin references with Ingrid Hartmann`);
    } catch (e) {
      console.warn('Could not access Remark42 iframe (CORS):', e);
    }
  }

  // Run replacement after Remark42 loads
  // Try multiple times as content loads dynamically
  setTimeout(() => replaceAdminWithIngrid(), 3000);
  setTimeout(() => replaceAdminWithIngrid(), 5000);
  setTimeout(() => replaceAdminWithIngrid(), 7000);

  // Also run on new comments (mutation observer)
  const observer = new MutationObserver(() => {
    replaceAdminWithIngrid();
  });

  setTimeout(() => {
    const iframe = document.querySelector('iframe[id^="remark42"]');
    if (iframe && iframe.contentDocument) {
      try {
        observer.observe(iframe.contentDocument.body, {
          childList: true,
          subtree: true
        });
        console.log('Started observing Remark42 for new admin comments');
      } catch (e) {
        console.warn('Could not observe Remark42 iframe:', e);
      }
    }
  }, 4000);
</script>

<style>
  /* Lokale Styles nur f√ºr Wrapper-Elemente */
  /* Remark42-Iframe-Styles m√ºssen √ºber /remark42-custom.css auf dem Server geladen werden */

  #remark42 {
    margin-top: 1rem;
  }

  #turnstile-container {
    display: inline-block;
  }

  #turnstile-wrapper,
  #remark42 {
    transition: opacity 0.3s ease-in-out;
  }
</style>
