---
import type { CollectionEntry } from "astro:content";

interface Props {
  relatedPosts: CollectionEntry<"blog">[];
}

const { relatedPosts } = Astro.props;

// Limitiere auf maximal 12 Beiträge
const posts = relatedPosts.slice(0, 12);

// Convert ISO 8601 duration to minutes
function parseDuration(duration?: string): number | null {
  if (!duration) return null;
  const match = duration.match(/PT(\d+)M/);
  return match ? parseInt(match[1]) : null;
}

// Map difficulty to display text
const difficultyMap: Record<string, string> = {
  einfach: "Einfach",
  mittel: "Mittel",
  schwer: "Fortgeschritten",
};

// Berechne Anzahl der Schritte (immer 3 Karten pro Schritt)
const totalSteps = Math.ceil(posts.length / 3);

// Schema.org ItemList für SEO
const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Verwandte Rezepte",
  "itemListElement": posts.map((post, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": `https://die-mama-kocht.de/rezepte/${post.data.metadata.slug}`,
    "name": post.data.metadata.title,
  })),
};
---

{posts.length > 0 && (
  <section
    class="related-posts"
    aria-labelledby="related-posts-heading"
  >
    <h2 id="related-posts-heading" class="related-posts__heading">
      Verwandte Rezepte
    </h2>

    <div class="related-posts__carousel-container">
      <!-- Previous Button -->
      <button
        type="button"
        class="related-posts__nav-button related-posts__nav-button--prev"
        aria-label="Vorherige Rezepte anzeigen"
        data-carousel-prev
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="related-posts__nav-icon"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          />
        </svg>
      </button>

      <!-- Carousel Wrapper -->
      <div class="related-posts__carousel-wrapper">
        <!-- Carousel Track -->
        <div
          class="related-posts__carousel"
          role="list"
          aria-label="Liste verwandter Rezepte"
          data-carousel-track
        >
          {posts.map((post) => {
            const featuredImage = post.data.images?.featured?.src || 'https://picsum.photos/400/300';
            const altText = post.data.images?.featured?.alt || post.data.metadata.title;
            const totalMinutes = parseDuration(post.data.timing?.totalTime || post.data.timing?.cookTime);
            const cuisine = post.data.taxonomy?.cuisine;
            const servings = post.data.nutrition?.servings;
            const difficulty = post.data.taxonomy?.difficulty;

            return (
              <article
                class="related-posts__card"
                role="listitem"
              >
                <a
                  href={`/rezepte/${post.data.metadata.slug}`}
                  class="related-posts__card-link"
                >
                  <div class="related-posts__card-image-wrapper">
                    <img
                      src={featuredImage}
                      alt={altText}
                      class="related-posts__card-image"
                      loading="lazy"
                      width="400"
                      height="300"
                    />
                  </div>

                  <div class="related-posts__card-content">
                    <h3 class="related-posts__card-title">
                      {post.data.metadata.title}
                    </h3>

                    {/* Meta-Informationen */}
                    <div class="related-posts__card-meta-grid">
                      {totalMinutes && (
                        <div class="related-posts__card-meta-item">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="related-posts__card-icon"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                          </svg>
                          <span class="related-posts__card-meta-text">{totalMinutes} min</span>
                        </div>
                      )}

                      {cuisine && (
                        <div class="related-posts__card-meta-item">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="related-posts__card-icon"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                            />
                          </svg>
                          <span class="related-posts__card-meta-text">{cuisine}</span>
                        </div>
                      )}

                      {servings && (
                        <div class="related-posts__card-meta-item">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="related-posts__card-icon"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                            />
                          </svg>
                          <span class="related-posts__card-meta-text">{servings}</span>
                        </div>
                      )}

                      {difficulty && (
                        <div class="related-posts__card-meta-item">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="related-posts__card-icon"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            aria-hidden="true"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                          </svg>
                          <span class="related-posts__card-meta-text">{difficultyMap[difficulty] || difficulty}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </a>
              </article>
            );
          })}
        </div>
      </div>

      <!-- Next Button -->
      <button
        type="button"
        class="related-posts__nav-button related-posts__nav-button--next"
        aria-label="Nächste Rezepte anzeigen"
        data-carousel-next
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="related-posts__nav-icon"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"
          />
        </svg>
      </button>

      <!-- Accessibility: Info für Screen Reader -->
      <div class="sr-only" role="status" aria-live="polite" data-carousel-status>
        Zeige 3 von {posts.length} verwandten Rezepten.
      </div>
    </div>

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
  </section>
)}

<style>
  /* ==========================================
     RELATED POSTS CAROUSEL - MANUAL CONTROL
     ========================================== */

  .related-posts {
    container-type: inline-size;
    container-name: carousel;
    margin-block: 3rem;
  }

  .related-posts__heading {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid var(--color-accent);
  }

  /* Carousel Container with Navigation */
  .related-posts__carousel-container {
    position: relative;
  }

  /* Navigation Buttons - Overlay */
  .related-posts__nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-accent);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .related-posts__nav-button--prev {
    left: -1rem;
  }

  .related-posts__nav-button--next {
    right: -1rem;
  }

  .related-posts__nav-button:hover:not(:disabled) {
    background: hsla(214, 41%, 10%, 1.00);
    transform: translateY(-50%) scale(1.1);
  }

  .related-posts__nav-button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .related-posts__nav-button:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .related-posts__nav-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: white;
    transition: color 0.3s ease;
  }

  /* Carousel Wrapper - muss volle Container-Breite haben */
  .related-posts__carousel-wrapper {
    width: 100%; /* Explizit volle Breite */
    overflow: hidden;
    padding: 0.5rem 0; /* Padding für Schatten-Sichtbarkeit */
    margin: -0.5rem 0; /* Negative Margin um Padding zu kompensieren */
    container-type: inline-size; /* Wrapper als Container für cqw */
  }

  /* Carousel Track - Grid-Spalten mit cqw Units relativ zum Wrapper */
  .related-posts__carousel {
    --visible-items: 3;
    --gap-size: 0.375rem;

    display: grid;
    grid-auto-flow: column;
    /* cqw bezieht sich jetzt auf carousel-wrapper Breite */
    grid-auto-columns: calc((100cqw - (var(--visible-items) - 1) * var(--gap-size)) / var(--visible-items));
    gap: var(--gap-size);
    transition: transform 0.5s ease-in-out;
    padding-bottom: 0.5rem; /* Extra Padding für Schatten unten */
  }

  /* ==========================================
     CARD STYLES
     ========================================== */

  .related-posts__card {
    min-width: 0;
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .related-posts__card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  /* Link covers entire card */
  .related-posts__card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  /* Image Wrapper */
  .related-posts__card-image-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    background: var(--color-muted);
  }

  .related-posts__card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .related-posts__card:hover .related-posts__card-image {
    transform: scale(1.05);
  }

  /* Content */
  .related-posts__card-content {
    padding: 0.625rem;
  }

  /* Title */
  .related-posts__card-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-primary);
    margin: 0 0 0.5rem 0;
    line-height: 1.25;
    min-height: 2.5em; /* 2 Zeilen Höhe für einheitliches Layout */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-posts__card-link:hover .related-posts__card-title {
    color: var(--color-accent);
  }

  /* Meta Info Grid */
  .related-posts__card-meta-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.25rem;
  }

  .related-posts__card-meta-item {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    font-size: 0.65rem;
    color: var(--color-gray-600);
  }

  .related-posts__card-icon {
    width: 0.75rem;
    height: 0.75rem;
    flex-shrink: 0;
    color: var(--color-accent);
  }

  .related-posts__card-meta-text {
    font-weight: 500;
    color: var(--color-gray-700);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.65rem;
  }

  /* Screen Reader Only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* ==========================================
     RESPONSIVE DESIGN mit Container Queries
     Hinweis: Content-Bereich (lg:col-span-2) kann maximal ~790px breit werden
     ========================================== */

  /* Mobile: 1 Karte (bis 400px Container-Breite) */
  @container (max-width: 400px) {
    .related-posts__carousel {
      --visible-items: 1;
      --gap-size: 0.75rem;
    }

    .related-posts__nav-button {
      width: 2rem;
      height: 2rem;
    }

    .related-posts__nav-button--prev {
      left: 0;
    }

    .related-posts__nav-button--next {
      right: 0;
    }

    .related-posts__nav-icon {
      width: 1rem;
      height: 1rem;
    }

    .related-posts__card-content {
      padding: 0.875rem;
    }

    .related-posts__card-title {
      font-size: 0.9rem;
    }

    .related-posts__card-meta-grid {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .related-posts__card-meta-item {
      font-size: 0.75rem;
    }
  }

  /* Tablet: 2 Karten (401px - 650px Container-Breite) */
  @container (min-width: 401px) and (max-width: 650px) {
    .related-posts__carousel {
      --visible-items: 2;
      --gap-size: 0.5rem;
    }

    .related-posts__card-title {
      font-size: 0.9rem;
    }
  }

  /* Desktop: 3 Karten (ab 651px Container-Breite) */
  @container (min-width: 651px) {
    .related-posts__carousel {
      --visible-items: 3;
      --gap-size: 0.375rem;
    }
  }

  /* Fallback für Browser ohne Container Query Support */
  @supports not (container-type: inline-size) {
    @media (max-width: 640px) {
      .related-posts__carousel {
        --visible-items: 1;
        --gap-size: 0.75rem;
      }

      .related-posts__card-content {
        padding: 0.875rem;
      }

      .related-posts__card-title {
        font-size: 0.9rem;
      }

      .related-posts__nav-button {
        width: 2rem;
        height: 2rem;
      }

      .related-posts__nav-button--prev {
        left: 0;
      }

      .related-posts__nav-button--next {
        right: 0;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      .related-posts__carousel {
        --visible-items: 2;
        --gap-size: 0.5rem;
      }

      .related-posts__card-title {
        font-size: 0.9rem;
      }
    }

    @media (min-width: 1025px) {
      .related-posts__carousel {
        --visible-items: 3;
        --gap-size: 0.375rem;
      }
    }
  }
</style>

<script>
  // Carousel Navigation Logic
  class RelatedPostsCarousel {
    private track: HTMLElement;
    private prevButton: HTMLButtonElement;
    private nextButton: HTMLButtonElement;
    private statusElement: HTMLElement | null;
    private currentIndex: number = 0;
    private cardsPerView: number = 3;
    private totalCards: number = 0;

    constructor(container: HTMLElement) {
      this.track = container.querySelector('[data-carousel-track]') as HTMLElement;
      this.prevButton = container.querySelector('[data-carousel-prev]') as HTMLButtonElement;
      this.nextButton = container.querySelector('[data-carousel-next]') as HTMLButtonElement;
      this.statusElement = container.querySelector('[data-carousel-status]');

      if (!this.track || !this.prevButton || !this.nextButton) return;

      this.totalCards = this.track.children.length;
      this.updateCardsPerView();

      // Event Listeners
      this.prevButton.addEventListener('click', () => this.prev());
      this.nextButton.addEventListener('click', () => this.next());

      // Update on resize
      window.addEventListener('resize', () => {
        this.updateCardsPerView();
        this.updatePosition();
      });

      // Initial state
      this.updateButtons();
    }

    private updateCardsPerView() {
      // Verwende die Container-Breite (nicht Viewport), passend zu CSS Container Queries
      const containerWidth = this.track.parentElement?.offsetWidth || 0;

      if (containerWidth <= 400) {
        this.cardsPerView = 1;
      } else if (containerWidth <= 650) {
        this.cardsPerView = 2;
      } else {
        this.cardsPerView = 3;
      }
    }

    private next() {
      const maxIndex = Math.ceil(this.totalCards / this.cardsPerView) - 1;
      if (this.currentIndex < maxIndex) {
        this.currentIndex++;
        this.updatePosition();
      }
    }

    private prev() {
      if (this.currentIndex > 0) {
        this.currentIndex--;
        this.updatePosition();
      }
    }

    private updatePosition() {
      if (this.track.children.length === 0) return;

      const cardWidth = (this.track.children[0] as HTMLElement).offsetWidth;

      // Gap-Größe muss mit CSS Container Queries übereinstimmen
      const containerWidth = this.track.parentElement?.offsetWidth || 0;
      let gap = 6; // Default: 0.375rem

      if (containerWidth <= 400) {
        gap = 12; // 0.75rem für Mobile
      } else if (containerWidth <= 650) {
        gap = 8;  // 0.5rem für Tablet
      }

      const offset = this.currentIndex * this.cardsPerView * (cardWidth + gap);

      this.track.style.transform = `translateX(-${offset}px)`;
      this.updateButtons();
      this.updateStatus();
    }

    private updateButtons() {
      const maxIndex = Math.ceil(this.totalCards / this.cardsPerView) - 1;

      this.prevButton.disabled = this.currentIndex === 0;
      this.nextButton.disabled = this.currentIndex >= maxIndex;
    }

    private updateStatus() {
      if (this.statusElement) {
        const start = this.currentIndex * this.cardsPerView + 1;
        const end = Math.min((this.currentIndex + 1) * this.cardsPerView, this.totalCards);
        this.statusElement.textContent = `Zeige ${start}-${end} von ${this.totalCards} verwandten Rezepten.`;
      }
    }
  }

  // Initialize all carousels on the page
  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('.related-posts__carousel-container');
    carousels.forEach((carousel) => {
      new RelatedPostsCarousel(carousel as HTMLElement);
    });
  });
</script>
