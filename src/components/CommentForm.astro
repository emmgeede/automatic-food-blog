---
/**
 * Comment Form with hCaptcha Integration
 * Allows users to submit comments with ratings
 */
import StarRating from "./StarRating.astro";

interface Props {
  recipeUuid: string;
}

const { recipeUuid } = Astro.props;
const hCaptchaSiteKey = import.meta.env.PUBLIC_HCAPTCHA_SITE_KEY;
---

<div class="comment-form-container bg-neutral-100 rounded-lg p-6 mb-8">
  <h3 class="text-2xl font-display font-bold text-neutral-900 mb-6">
    Bewerten und kommentieren
  </h3>

  <form id="comment-form" class="space-y-4" data-recipe-uuid={recipeUuid}>
    <!-- Name Input -->
    <div class="form-group">
      <label for="name" class="block text-sm font-semibold text-neutral-700 mb-2">
        Name <span class="text-accent-DEFAULT">*</span>
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-DEFAULT focus:border-transparent transition-colors"
        placeholder="Ihr Name"
      />
    </div>

    <!-- Email Input -->
    <div class="form-group">
      <label for="email" class="block text-sm font-semibold text-neutral-700 mb-2">
        E-Mail <span class="text-accent-DEFAULT">*</span>
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-DEFAULT focus:border-transparent transition-colors"
        placeholder="ihre@email.de"
      />
      <p class="text-xs text-neutral-600 mt-1">
        Ihre E-Mail-Adresse wird nicht veröffentlicht.
      </p>
    </div>

    <!-- Rating Input -->
    <div class="form-group">
      <label class="block text-sm font-semibold text-neutral-700 mb-2">
        Bewertung <span class="text-accent-DEFAULT">*</span>
      </label>
      <StarRating interactive={true} size="lg" name="rating" />
      <p class="text-xs text-neutral-600 mt-1">Klicken Sie, um zu bewerten</p>
    </div>

    <!-- Message Input -->
    <div class="form-group">
      <label for="message" class="block text-sm font-semibold text-neutral-700 mb-2">
        Kommentar <span class="text-accent-DEFAULT">*</span>
      </label>
      <textarea
        id="message"
        name="message"
        rows="5"
        required
        class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-DEFAULT focus:border-transparent transition-colors resize-y"
        placeholder="Teilen Sie Ihre Erfahrungen mit diesem Rezept..."
      ></textarea>
    </div>

    <!-- hCaptcha -->
    {
      hCaptchaSiteKey && (
        <div class="form-group">
          <div class="h-captcha" data-sitekey={hCaptchaSiteKey} />
        </div>
      )
    }

    <!-- Error Message -->
    <div id="form-error" class="hidden bg-accent-DEFAULT/10 border border-accent-DEFAULT text-accent-DEFAULT px-4 py-3 rounded-lg" role="alert">
      <p class="text-sm font-medium"></p>
    </div>

    <!-- Success Message -->
    <div id="form-success" class="hidden bg-secondary-DEFAULT/10 border border-secondary-DEFAULT text-secondary-DEFAULT px-4 py-3 rounded-lg" role="alert">
      <p class="text-sm font-medium">
        Vielen Dank für Ihren Kommentar! Er wurde erfolgreich übermittelt.
      </p>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="w-full bg-primary-DEFAULT text-white font-semibold py-3 px-6 rounded-lg hover:bg-primary-DEFAULT/90 active:bg-primary-DEFAULT/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      id="submit-button"
    >
      Kommentar absenden
    </button>
  </form>
</div>

<!-- Load hCaptcha script -->
{hCaptchaSiteKey && <script src="https://js.hcaptcha.com/1/api.js" async defer></script>}

<script>
  interface CommentFormData {
    recipeUuid: string;
    name: string;
    email: string;
    message: string;
    rating: string;
    captchaToken: string;
  }

  class CommentFormHandler {
    private form: HTMLFormElement;
    private submitButton: HTMLButtonElement;
    private errorDiv: HTMLElement;
    private successDiv: HTMLElement;
    private recipeUuid: string;

    constructor(formElement: HTMLFormElement) {
      this.form = formElement;
      this.submitButton = formElement.querySelector("#submit-button")!;
      this.errorDiv = formElement.querySelector("#form-error")!;
      this.successDiv = formElement.querySelector("#form-success")!;
      this.recipeUuid = formElement.dataset.recipeUuid || "";

      this.attachEventListeners();
    }

    private attachEventListeners() {
      this.form.addEventListener("submit", (e) => this.handleSubmit(e));
    }

    private async handleSubmit(event: Event) {
      event.preventDefault();

      // Hide previous messages
      this.hideMessages();

      // Disable submit button
      this.submitButton.disabled = true;
      this.submitButton.textContent = "Wird gesendet...";

      try {
        // Get form data
        const formData = new FormData(this.form);
        const name = formData.get("name") as string;
        const email = formData.get("email") as string;
        const message = formData.get("message") as string;
        const rating = formData.get("rating") as string;

        // Get hCaptcha token
        let captchaToken = "";
        const hCaptchaResponse = formData.get("h-captcha-response") as string;
        if (hCaptchaResponse) {
          captchaToken = hCaptchaResponse;
        } else {
          // Try to get it from window object (hCaptcha adds it there)
          const hcaptcha = (window as any).hcaptcha;
          if (hcaptcha) {
            captchaToken = hcaptcha.getResponse();
          }
        }

        // Validate
        if (!name || !email || !message || !rating) {
          this.showError("Bitte füllen Sie alle erforderlichen Felder aus.");
          return;
        }

        if (!captchaToken) {
          this.showError("Bitte bestätigen Sie das Captcha.");
          return;
        }

        // Submit to API
        const response = await fetch("/api/comments/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            recipeUuid: this.recipeUuid,
            name,
            email,
            message,
            rating: parseInt(rating),
            captchaToken,
          }),
        });

        const result = await response.json();

        if (result.success) {
          this.showSuccess();
          this.form.reset();

          // Reset star rating
          const starRating = this.form.querySelector("star-rating");
          if (starRating) {
            starRating.setAttribute("data-rating", "0");
            const hiddenInput = starRating.querySelector('input[type="hidden"]');
            if (hiddenInput) {
              (hiddenInput as HTMLInputElement).value = "0";
            }
          }

          // Reset hCaptcha
          const hcaptcha = (window as any).hcaptcha;
          if (hcaptcha) {
            hcaptcha.reset();
          }

          // Dispatch event to reload comments
          window.dispatchEvent(new CustomEvent("commentAdded"));
        } else {
          this.showError(result.error || "Ein Fehler ist aufgetreten.");
        }
      } catch (error) {
        console.error("Error submitting comment:", error);
        this.showError("Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.");
      } finally {
        // Re-enable submit button
        this.submitButton.disabled = false;
        this.submitButton.textContent = "Kommentar absenden";
      }
    }

    private showError(message: string) {
      this.errorDiv.querySelector("p")!.textContent = message;
      this.errorDiv.classList.remove("hidden");
      this.successDiv.classList.add("hidden");
    }

    private showSuccess() {
      this.successDiv.classList.remove("hidden");
      this.errorDiv.classList.add("hidden");
    }

    private hideMessages() {
      this.errorDiv.classList.add("hidden");
      this.successDiv.classList.add("hidden");
    }
  }

  // Initialize form handler
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("comment-form") as HTMLFormElement;
    if (form) {
      new CommentFormHandler(form);
    }
  });
</script>
