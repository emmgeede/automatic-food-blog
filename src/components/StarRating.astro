---
/**
 * Interactive Star Rating Component
 * Supports both display mode (read-only) and input mode (interactive)
 */
interface Props {
  rating?: number; // Current rating value (0-5)
  interactive?: boolean; // Whether the stars are clickable
  size?: "sm" | "md" | "lg"; // Size of the stars
  name?: string; // Name for the hidden input field (used in forms)
}

const { rating = 0, interactive = false, size = "md", name = "rating" } = Astro.props;

// Size classes for stars
const sizeClasses = {
  sm: "w-4 h-4",
  md: "w-6 h-6",
  lg: "w-8 h-8",
};

const starSize = sizeClasses[size];
---

<star-rating
  class="star-rating inline-flex gap-1"
  data-rating={rating}
  data-interactive={interactive}
  data-name={name}
>
  {
    [1, 2, 3, 4, 5].map((star) => (
      <button
        type="button"
        class:list={[
          "star-button transition-colors duration-200",
          starSize,
          interactive ? "cursor-pointer hover:scale-110 active:scale-95" : "cursor-default",
        ]}
        data-star={star}
        aria-label={`${star} von 5 Sternen`}
        disabled={!interactive}
      >
        <svg
          class="star-icon w-full h-full"
          fill="currentColor"
          viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      </button>
    ))
  }
  {interactive && <input type="hidden" name={name} value={rating} />}
</star-rating>

<style>
  .star-button {
    background: none;
    border: none;
    padding: 0;
    color: theme("colors.muted.DEFAULT");
  }

  .star-button.filled {
    color: theme("colors.accent.DEFAULT");
  }

  .star-button.hovered {
    color: theme("colors.accent.DEFAULT");
    opacity: 0.7;
  }
</style>

<script>
  class StarRatingElement extends HTMLElement {
    private rating: number = 0;
    private interactive: boolean = false;
    private hoveredStar: number | null = null;
    private buttons: HTMLButtonElement[] = [];
    private hiddenInput: HTMLInputElement | null = null;

    connectedCallback() {
      this.rating = parseFloat(this.dataset.rating || "0");
      this.interactive = this.dataset.interactive === "true";

      this.buttons = Array.from(this.querySelectorAll(".star-button"));
      this.hiddenInput = this.querySelector('input[type="hidden"]');

      if (this.interactive) {
        this.attachEventListeners();
      }

      this.updateStars();
    }

    private attachEventListeners() {
      this.buttons.forEach((button, index) => {
        button.addEventListener("click", () => {
          this.rating = index + 1;
          if (this.hiddenInput) {
            this.hiddenInput.value = String(this.rating);
          }
          this.updateStars();
          this.dispatchEvent(
            new CustomEvent("ratingChange", {
              detail: { rating: this.rating },
              bubbles: true,
            })
          );
        });

        button.addEventListener("mouseenter", () => {
          if (this.interactive) {
            this.hoveredStar = index + 1;
            this.updateStars();
          }
        });
      });

      this.addEventListener("mouseleave", () => {
        this.hoveredStar = null;
        this.updateStars();
      });
    }

    private updateStars() {
      const displayRating = this.hoveredStar !== null ? this.hoveredStar : this.rating;

      this.buttons.forEach((button, index) => {
        button.classList.remove("filled", "hovered");

        if (index < displayRating) {
          if (this.hoveredStar !== null) {
            button.classList.add("hovered");
          } else {
            button.classList.add("filled");
          }
        }
      });
    }
  }

  customElements.define("star-rating", StarRatingElement);
</script>
