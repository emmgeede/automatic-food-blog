---
/**
 * Recipe Filter Page
 * Amazon-style sidebar filtering with multi-criteria search
 */
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "../layouts/BaseLayout.astro";
import DietaryLabelsDisplay from "../components/DietaryLabelsDisplay.astro";

// Get all recipes
const allRecipes = await getCollection("blog");

// Prepare canonical URL
const canonicalURL = Astro.site
  ? new URL('/filter', Astro.site).toString()
  : '/filter';

// Frontmatter for BaseLayout
const frontmatter = {
  title: 'Rezepte filtern',
  metaDescription: 'Finde dein perfektes Rezept mit unseren umfangreichen Filter-Optionen. Nach Kategorie, Ernährungsweise, Zeit und mehr.',
  metaKeywords: 'Rezepte, Filter, Suche, vegan, vegetarisch, schnell',
  metaCanonical: canonicalURL,
  featuredImage: '/og-default.jpg',
  ogType: 'website',
};

// Extract unique values for filter options
const categories = [...new Set(allRecipes.flatMap(r => r.data.taxonomy?.categories || []))].sort();
const cuisines = [...new Set(allRecipes.map(r => r.data.taxonomy?.cuisine).filter(Boolean))].sort();
const difficulties = ['einfach', 'mittel', 'schwer'];
const timeRanges = [
  { label: 'Unter 15 Min', value: '0-15' },
  { label: '15-30 Min', value: '15-30' },
  { label: '30-60 Min', value: '30-60' },
  { label: 'Über 1 Stunde', value: '60+' },
];

// Dietary labels
const dietaryOptions = [
  { key: 'vegan', label: 'Vegan' },
  { key: 'vegetarian', label: 'Vegetarisch' },
  { key: 'glutenFree', label: 'Glutenfrei' },
  { key: 'dairyFree', label: 'Laktosefrei' },
  { key: 'keto', label: 'Keto' },
  { key: 'paleo', label: 'Paleo' },
  { key: 'highProtein', label: 'High Protein' },
  { key: 'lowCarb', label: 'Low Carb' },
];

// Count recipes for each filter option
function countRecipes(filterFn: (recipe: any) => boolean): number {
  return allRecipes.filter(filterFn).length;
}

// Prepare recipes data for client-side filtering
const recipesData = allRecipes.map(recipe => ({
  slug: recipe.data.metadata?.slug,
  title: recipe.data.metadata?.title,
  description: recipe.data.metadata?.description,
  image: recipe.data.images?.featured?.src,
  imageAlt: recipe.data.images?.featured?.alt,
  categories: recipe.data.taxonomy?.categories || [],
  cuisine: recipe.data.taxonomy?.cuisine,
  difficulty: recipe.data.taxonomy?.difficulty,
  totalTime: recipe.data.timing?.totalTime || recipe.data.timing?.cookTime,
  dietaryLabels: recipe.data.dietaryLabels,
}));
---

<BaseLayout frontmatter={frontmatter}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">
        Rezepte filtern
      </h1>
      <p class="text-lg text-gray-600">
        Finde dein perfektes Rezept mit unseren Filter-Optionen
      </p>
    </header>

    <!-- Filter Layout: Sidebar + Results -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Sidebar Filter (Desktop) -->
      <aside
        id="filter-sidebar"
        class="lg:col-span-1 space-y-6 hidden lg:block sticky top-8 self-start max-h-[calc(100vh-8rem)] overflow-y-auto"
        aria-label="Rezept-Filter"
      >
        <!-- Filter Header -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-900">Filter</h2>
          <button
            id="clear-filters"
            class="text-sm text-accent hover:text-accent-dark font-semibold hidden"
          >
            Alle löschen
          </button>
        </div>

        <!-- Active Filters -->
        <div id="active-filters" class="hidden">
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Aktive Filter:</h3>
          <div id="filter-chips" class="flex flex-wrap gap-2 mb-4"></div>
        </div>

        <!-- Kategorien Filter -->
        <div class="filter-group">
          <input type="checkbox" id="toggle-categories" class="accordion-toggle" checked />
          <label for="toggle-categories" class="text-lg font-semibold text-gray-900 mb-3 flex items-center justify-between cursor-pointer">
            Kategorien
            <svg class="accordion-arrow w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </label>
          <div class="accordion-content">
            <div class="space-y-2">
              {categories.slice(0, 10).map(category => (
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input
                    type="checkbox"
                    name="category"
                    value={category}
                    class="w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                  />
                  <span class="text-sm text-gray-700 flex-grow">{category}</span>
                  <span class="text-xs text-gray-500 category-count" data-category={category}>
                    ({countRecipes(r => r.data.taxonomy?.categories?.includes(category))})
                  </span>
                </label>
              ))}
            </div>
          </div>
        </div>

        <!-- Ernährungsweise Filter -->
        <div class="filter-group">
          <input type="checkbox" id="toggle-dietary" class="accordion-toggle" checked />
          <label for="toggle-dietary" class="text-lg font-semibold text-gray-900 mb-3 flex items-center justify-between cursor-pointer">
            Ernährungsweise
            <svg class="accordion-arrow w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </label>
          <div class="accordion-content">
            <div class="space-y-2">
              {dietaryOptions.map(option => (
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input
                    type="checkbox"
                    name="dietary"
                    value={option.key}
                    class="w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                  />
                  <span class="text-sm text-gray-700 flex-grow">{option.label}</span>
                  <span class="text-xs text-gray-500 dietary-count" data-dietary={option.key}>
                    ({countRecipes(r => r.data.dietaryLabels?.[option.key] === true)})
                  </span>
                </label>
              ))}
            </div>
          </div>
        </div>

        <!-- Zubereitungszeit Filter -->
        <div class="filter-group">
          <input type="checkbox" id="toggle-time" class="accordion-toggle" checked />
          <label for="toggle-time" class="text-lg font-semibold text-gray-900 mb-3 flex items-center justify-between cursor-pointer">
            Zubereitungszeit
            <svg class="accordion-arrow w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </label>
          <div class="accordion-content">
            <div class="space-y-2">
              {timeRanges.map(range => (
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input
                    type="checkbox"
                    name="time"
                    value={range.value}
                    class="w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                  />
                  <span class="text-sm text-gray-700 flex-grow">{range.label}</span>
                  <span class="text-xs text-gray-500 time-count" data-time={range.value}>
                  </span>
                </label>
              ))}
            </div>
          </div>
        </div>

        <!-- Schwierigkeit Filter -->
        <div class="filter-group">
          <input type="checkbox" id="toggle-difficulty" class="accordion-toggle" checked />
          <label for="toggle-difficulty" class="text-lg font-semibold text-gray-900 mb-3 flex items-center justify-between cursor-pointer">
            Schwierigkeit
            <svg class="accordion-arrow w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </label>
          <div class="accordion-content">
            <div class="space-y-2">
              {difficulties.map(difficulty => (
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input
                    type="checkbox"
                    name="difficulty"
                    value={difficulty}
                    class="w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                  />
                  <span class="text-sm text-gray-700 flex-grow capitalize">{difficulty}</span>
                  <span class="text-xs text-gray-500 difficulty-count" data-difficulty={difficulty}>
                    ({countRecipes(r => r.data.taxonomy?.difficulty === difficulty)})
                  </span>
                </label>
              ))}
            </div>
          </div>
        </div>

        <!-- Küche Filter -->
        <div class="filter-group">
          <input type="checkbox" id="toggle-cuisine" class="accordion-toggle" checked />
          <label for="toggle-cuisine" class="text-lg font-semibold text-gray-900 mb-3 flex items-center justify-between cursor-pointer">
            Küche
            <svg class="accordion-arrow w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </label>
          <div class="accordion-content">
            <div class="space-y-2">
              {cuisines.slice(0, 8).map(cuisine => (
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input
                    type="checkbox"
                    name="cuisine"
                    value={cuisine}
                    class="w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                  />
                  <span class="text-sm text-gray-700 flex-grow">{cuisine}</span>
                  <span class="text-xs text-gray-500 cuisine-count" data-cuisine={cuisine}>
                    ({countRecipes(r => r.data.taxonomy?.cuisine === cuisine)})
                  </span>
                </label>
              ))}
            </div>
          </div>
        </div>
      </aside>

      <!-- Results Column -->
      <div class="lg:col-span-3">
        <!-- Mobile Filter Button -->
        <button
          id="mobile-filter-button"
          class="lg:hidden w-full mb-6 bg-accent text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
          </svg>
          Filter
          <span id="mobile-filter-count" class="hidden bg-white text-accent px-2 py-0.5 rounded-full text-sm"></span>
        </button>

        <!-- Results Header -->
        <div class="mb-6 flex items-center justify-between">
          <p id="results-count" class="text-lg font-semibold text-gray-900">
            {allRecipes.length} Rezepte
          </p>
          <select
            id="sort-select"
            class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-accent focus:border-accent"
          >
            <option value="newest">Neueste zuerst</option>
            <option value="oldest">Älteste zuerst</option>
            <option value="title-asc">Titel A-Z</option>
            <option value="title-desc">Titel Z-A</option>
          </select>
        </div>

        <!-- Recipe Grid -->
        <div id="recipe-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Recipes will be rendered here by JavaScript -->
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-16">
          <p class="text-xl text-gray-600 mb-4">
            Keine Rezepte gefunden.
          </p>
          <button
            id="clear-filters-no-results"
            class="inline-block bg-accent hover:bg-accent-dark text-white font-semibold py-3 px-6 rounded-lg transition-colors"
          >
            Alle Filter zurücksetzen
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Client-Side Filtering Script -->
  <script is:inline define:vars={{ recipesData }}>
    // Parse time from ISO 8601 duration
    function parseTime(duration) {
      if (!duration) return null;
      const match = duration.match(/PT(\d+)M/);
      return match ? parseInt(match[1]) : null;
    }

    // Check if time is in range
    function isInTimeRange(minutes, range) {
      if (!minutes) return false;
      const [min, max] = range.split('-').map(n => n === '+' ? Infinity : parseInt(n));
      return minutes >= min && (max === undefined ? minutes >= min : minutes <= max);
    }

    // Get active filters from checkboxes
    function getActiveFilters() {
      return {
        categories: Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value),
        dietary: Array.from(document.querySelectorAll('input[name="dietary"]:checked')).map(cb => cb.value),
        time: Array.from(document.querySelectorAll('input[name="time"]:checked')).map(cb => cb.value),
        difficulty: Array.from(document.querySelectorAll('input[name="difficulty"]:checked')).map(cb => cb.value),
        cuisine: Array.from(document.querySelectorAll('input[name="cuisine"]:checked')).map(cb => cb.value),
      };
    }

    // Filter recipes
    function filterRecipes() {
      const filters = getActiveFilters();
      const sortValue = document.getElementById('sort-select').value;

      let filtered = recipesData.filter(recipe => {
        // Category filter
        if (filters.categories.length > 0) {
          if (!filters.categories.some(cat => recipe.categories.includes(cat))) {
            return false;
          }
        }

        // Dietary filter
        if (filters.dietary.length > 0) {
          if (!filters.dietary.some(diet => recipe.dietaryLabels?.[diet] === true)) {
            return false;
          }
        }

        // Time filter
        if (filters.time.length > 0) {
          const minutes = parseTime(recipe.totalTime);
          if (!filters.time.some(range => isInTimeRange(minutes, range))) {
            return false;
          }
        }

        // Difficulty filter
        if (filters.difficulty.length > 0) {
          if (!filters.difficulty.includes(recipe.difficulty)) {
            return false;
          }
        }

        // Cuisine filter
        if (filters.cuisine.length > 0) {
          if (!filters.cuisine.includes(recipe.cuisine)) {
            return false;
          }
        }

        return true;
      });

      // Sort results
      if (sortValue === 'title-asc') {
        filtered.sort((a, b) => a.title.localeCompare(b.title));
      } else if (sortValue === 'title-desc') {
        filtered.sort((a, b) => b.title.localeCompare(a.title));
      }

      return filtered;
    }

    // Render recipes
    function renderRecipes() {
      const filtered = filterRecipes();
      const grid = document.getElementById('recipe-grid');
      const noResults = document.getElementById('no-results');
      const resultsCount = document.getElementById('results-count');

      // Update count
      resultsCount.textContent = `${filtered.length} ${filtered.length === 1 ? 'Rezept' : 'Rezepte'}`;

      // Show/hide no results
      if (filtered.length === 0) {
        grid.classList.add('hidden');
        noResults.classList.remove('hidden');
        return;
      } else {
        grid.classList.remove('hidden');
        noResults.classList.add('hidden');
      }

      // Render recipe cards
      grid.innerHTML = filtered.map(recipe => `
        <article class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300">
          <a href="/rezepte/${recipe.slug}">
            ${recipe.image ? `
              <div class="relative aspect-video overflow-hidden">
                <img
                  src="${recipe.image}"
                  alt="${recipe.imageAlt || recipe.title}"
                  class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                  loading="lazy"
                />
              </div>
            ` : ''}
            <div class="p-6">
              ${recipe.categories[0] ? `
                <span class="text-accent text-xs font-semibold uppercase tracking-wide">
                  ${recipe.categories[0]}
                </span>
              ` : ''}
              <h3 class="text-xl font-bold text-gray-900 mt-2 mb-3 hover:text-accent transition-colors">
                ${recipe.title}
              </h3>
              ${recipe.description ? `
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                  ${recipe.description}
                </p>
              ` : ''}
            </div>
          </a>
        </article>
      `).join('');

      // Update filter visibility
      updateFilterVisibility();
    }

    // Update filter visibility (show/hide "Clear all" button, etc.)
    function updateFilterVisibility() {
      const filters = getActiveFilters();
      const hasActiveFilters = Object.values(filters).some(arr => arr.length > 0);

      const clearButton = document.getElementById('clear-filters');
      const activeFiltersDiv = document.getElementById('active-filters');
      const mobileFilterCount = document.getElementById('mobile-filter-count');

      if (hasActiveFilters) {
        clearButton.classList.remove('hidden');
        activeFiltersDiv.classList.remove('hidden');

        const totalFilters = Object.values(filters).reduce((sum, arr) => sum + arr.length, 0);
        mobileFilterCount.textContent = totalFilters;
        mobileFilterCount.classList.remove('hidden');

        // Render filter chips
        renderFilterChips(filters);
      } else {
        clearButton.classList.add('hidden');
        activeFiltersDiv.classList.add('hidden');
        mobileFilterCount.classList.add('hidden');
      }
    }

    // Render active filter chips
    function renderFilterChips(filters) {
      const chipsContainer = document.getElementById('filter-chips');
      const allFilters = [
        ...filters.categories.map(f => ({ type: 'category', value: f, label: f })),
        ...filters.dietary.map(f => ({ type: 'dietary', value: f, label: f })),
        ...filters.time.map(f => ({ type: 'time', value: f, label: f })),
        ...filters.difficulty.map(f => ({ type: 'difficulty', value: f, label: f })),
        ...filters.cuisine.map(f => ({ type: 'cuisine', value: f, label: f })),
      ];

      chipsContainer.innerHTML = allFilters.map(filter => `
        <button
          class="inline-flex items-center gap-1 bg-black text-white text-sm px-3 py-1 rounded-full hover:bg-gray-800"
          data-filter-type="${filter.type}"
          data-filter-value="${filter.value}"
        >
          ${filter.label}
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      `).join('');

      // Add click handlers for chips
      chipsContainer.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
          const type = button.dataset.filterType;
          const value = button.dataset.filterValue;
          const checkbox = document.querySelector(`input[name="${type}"][value="${value}"]`);
          if (checkbox) {
            checkbox.checked = false;
            renderRecipes();
          }
        });
      });
    }

    // Clear all filters
    function clearAllFilters() {
      // Reset all filter checkboxes (but keep accordion states)
      document.querySelectorAll('input[type="checkbox"]:not(.accordion-toggle)').forEach(cb => cb.checked = false);
      renderRecipes();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Initial render
      renderRecipes();

      // Add event listeners to all filter checkboxes (excluding accordion toggles)
      document.querySelectorAll('input[type="checkbox"]:not(.accordion-toggle)').forEach(checkbox => {
        checkbox.addEventListener('change', renderRecipes);
      });

      // Sort change
      document.getElementById('sort-select').addEventListener('change', renderRecipes);

      // Clear filters buttons
      document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
      document.getElementById('clear-filters-no-results').addEventListener('click', clearAllFilters);

      // Mobile filter button (placeholder - you can add modal logic here)
      document.getElementById('mobile-filter-button').addEventListener('click', () => {
        const sidebar = document.getElementById('filter-sidebar');
        sidebar.classList.toggle('hidden');
        sidebar.classList.toggle('lg:block');
      });
    });
  </script>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Accordion Styles - CSS Only */
  .accordion-toggle {
    display: none;
  }

  .accordion-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
    opacity: 1;
  }

  .accordion-toggle:not(:checked) + label + .accordion-content {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out;
  }

  .accordion-arrow {
    transition: transform 0.3s ease-in-out;
  }

  .accordion-toggle:checked + label .accordion-arrow {
    transform: rotate(180deg);
  }

  .accordion-toggle:not(:checked) + label {
    margin-bottom: 0;
  }
</style>
